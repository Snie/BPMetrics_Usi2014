<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="collection-drop.html">
<script src="../bower_components/chartjs/Chart.js"></script>

<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<script src="../bower_components/jquery-1.11.1.min.js"></script>


<polymer-element name="metric-card" attributes="post side oGraph statistic">
    <template>
        <style>
            :host {
                /*box-shadow: 0 0 1px #000000;*/
                border-radius: 3px;
                display: block;
                position: relative;
                background-color: white;
                padding: 20px;
                font-size: 0.7rem;
                font-weight: 300;
                width: 300px;
                height: 300px;

                margin:10px;
            }
            polyfill-next-selector { content: '.card-header h2'; }
            .card-header ::content h2 {
                margin: 0;
                font-size: 1.2rem;
                font-weight: 300;
            }
            core-icon-button {
                position: absolute;
                top: 2px;
                right: 2px;
                padding:2px;
                color: #636363;
            }
            :host([favorite]) core-icon-button {
                color: #da4336;
            }
            #front{
                display: block;
            }
            #back{
                display: none;
            }
            paper-dropdown-menu{
                width: 100%;
            }
            paper-item{
                width: 100%;
            }
            table{
                width: 100%;
            }

        </style>


        <div id="front">
            <div class="card-header" layout horizontal center>
                <content select="h2"></content>
            </div>

            <core-icon-button icon="settings" on-tap="{{settingsTapped}}"></core-icon-button>


            <canvas class="cc" id="canvas" width="300" height="200"></canvas>

            <div id="table">
            </div>

        </div>

        <div id="back">
            <core-icon-button icon="clear" on-tap="{{settingsTapped}}"></core-icon-button>
            <paper-dropdown-menu label="Level of Compare">
                <paper-dropdown class="dropdown">
                    <core-menu class="menu">
                        <paper-item>Global</paper-item>
                        <paper-item on-click="{{getGlobal}}">Account</paper-item>
                        <!--<paper-item on-click="{{colChoose}}">Collection</paper-item>-->
                    </core-menu>
                </paper-dropdown>
            </paper-dropdown-menu>

            <div id="selection">

            </div>
        </div>

    </template>


    <script>
        function name(name){
            temp = '';
            for(var i = 0; i < name.length; i++){
                if(name[i] === name[i].toUpperCase()){
                    temp += name[i] +'.'
                }
            }
            return temp;
        }
        Polymer('metric-card', {
            ready: function() {
//                if(this.post.value = []){
//                    this.style.borderBottom = 'solid 4px blue';
//                }
                this.side = true;
                var t = this.$.canvas;

                var ctx = t.getContext("2d");

                var labels = [];
                var datas = [];
                var mean = [];
                var median = [];
                var chartOpt = {};
                var data = {};

                if(this.post.type == 'DISTRIBUTION') {

                    for (var i = 0; i < this.post.values.length; i++) {
                        labels.push(this.post.values[i].name);
                        datas.push(this.post.values[i].value);
                    }

                    if (this.post.values.length >= 1) {

                        data = {
                            labels: labels,
                            datasets: [
                                {
                                    label: "First dataset",
                                    fillColor: "rgba(0,200,200,0.5)",
                                    strokeColor: "rgba(0,200,200,0.8)",
                                    highlightFill: "rgba(0,200,200,0.75)",
                                    highlightStroke: "rgba(0,200,200,1)",
                                    data: datas
                                }
                            ]
                        };

                        var min = Math.min.apply(null, data.datasets[0].data);
                        var max = Math.max.apply(null, data.datasets[0].data);


                        chartOpt = {
                            scaleOverride: true,
                            scaleSteps: max + 2,
                            scaleStepWidth: 1,
                            animation: false  // Edit: correction typo: from 'animated' to 'animation'
                        };

                        this.$.table.innerHTML = "<table><tr><td>Minimum</td><td>" + Math.round(this.post.minimum * 100000) / 100000 + "</td></tr><tr><td>Maximum</td><td>" + Math.round(this.post.maximum * 100000) / 100000 + "</td></tr><tr><td>Sum</td><td>" + Math.round(this.statistic.sum * 100000) / 100000 + "</td></tr></table>"
                        myBarChart = new Chart(ctx).Bar(data, chartOpt);
                    }
                    else{
                        this.hidden = true;
                    }
                }
                else if(this.post.type == 'SINGLE_VALUE'){

                    if(this.post.values[0].value == 0) {
                        this.style.borderBottom = "solid 4px #da4336";
                    }

                    for(var i = 0; i < this.post.values.length; i++){
                        labels.push('value');
                        labels.push('mean');
                        labels.push('median');
                        datas.push(this.post.values[i].value);
                        datas.push(this.statistic.mean[0]);
                        datas.push(this.statistic.median);
                    }

                    data = {
                        labels: labels,
                        datasets: [
                            {
                                label: "First dataset",
                                fillColor: "rgba(0,200,200,0.5)",
                                strokeColor: "rgba(0,200,200,0.8)",
                                highlightFill: "rgba(0,200,200,0.75)",
                                highlightStroke: "rgba(0,200,200,1)",
                                data: datas
                            }
                        ]
                    };

                    var min = Math.min.apply(null, data.datasets[0].data);
                    var max = Math.max.apply(null, data.datasets[0].data);

                    chartOpt = {
                        scaleOverride : true,
                        scaleSteps : max + 2,
                        scaleStepWidth : 1,
                        animation : false  // Edit: correction typo: from 'animated' to 'animation'
                    };

                    var myBarChart = new Chart(ctx).Bar(data, chartOpt);

                    this.$.table.innerHTML = "<table><tr><td>Variance</td><td>"+Math.round(this.statistic.variance * 100000) / 100000+"</td></tr><tr><td>Standard Deviation</td><td>"+Math.round(this.statistic.standard_deviation * 100000) / 100000+"</td></tr><tr><td>Range</td><td>"+Math.round(this.statistic.range[0] * 100000) / 100000+" - "+Math.round(this.statistic.range[1] * 100000) / 100000+"</td></tr></table>"
                }
                else if(this.post.type == 'TYPE_DISTRIBUTION'){
                    console.log(this.statistic);

                    for(var i = 0; i < this.post.values.length; i++){
                        labels.push(name(this.post.values[i].name));
                        datas.push(this.post.values[i].value);
                        mean.push(this.statistic.names[i].mean[0]);
                        median.push(this.statistic.names[i].median);


                    }


                    data = {
                        labels: labels,
                        datasets: [
                            {
                                label: "First dataset",
                                fillColor: "rgba(0,200,200,0.5)",
                                strokeColor: "rgba(0,200,200,0.8)",
                                highlightFill: "rgba(0,200,200,0.75)",
                                highlightStroke: "rgba(0,200,200,1)",
                                data: datas
                            },
                            {
                                label: "mean",
                                fillColor: "rgba(200,200,0,0.5)",
                                strokeColor: "rgba(200,200,0,0.8)",
                                highlightFill: "rgba(200,200,0,0.75)",
                                highlightStroke: "rgba(200,200,0,1)",
                                data: mean
                            },
                            {
                                label: "median",
                                fillColor: "rgba(200,0,0,0.5)",
                                strokeColor: "rgba(200,0,0,0.8)",
                                highlightFill: "rgba(200,0,0,0.75)",
                                highlightStroke: "rgba(200,0,0,1)",
                                data: median
                            }
                        ]
                    };

                    var min = Math.min.apply(null, data.datasets[0].data);
                    var max = Math.max.apply(null, data.datasets[0].data);



                    chartOpt = {
                        scaleOverride : true,
                        scaleSteps : max ,
                        scaleStepWidth : 1,
                        animation : false  // Edit: correction typo: from 'animated' to 'animation'
                    };

                    var myBarChart = new Chart(ctx).Bar(data, chartOpt);
                }

            },
            statisticChange: function(){
                if(this.post.type == 'DISTRIBUTION'){

                    for(var i = 0; i < this.post.values.length; i++){
                        labels.push(this.post.values[i].name);
                        datas.push(this.post.values[i].value);
                    }

                    console.log(JSON.parse(this.post.values));

                    data = {
                        labels: labels,
                        datasets: [
                            {
                                label: "First dataset",
                                fillColor: "rgba(220,220,220,0.5)",
                                strokeColor: "rgba(220,220,220,0.8)",
                                highlightFill: "rgba(220,220,220,0.75)",
                                highlightStroke: "rgba(220,220,220,1)",
                                data: datas
                            }
                        ]
                    };



                    chartOpt = {
                        scaleOverride : true,
                        scaleSteps : 10,
                        scaleStepWidth : 1,
                        animation : false  // Edit: correction typo: from 'animated' to 'animation'
                    };

                    myBarChart = new Chart(ctx).Bar(data, chartOpt);
                }
                else if(this.post.type == 'SINGLE_VALUE'){

                    if(this.post.values[0].value == 0) {
                        this.style.borderBottom = "solid 4px #da4336";
                    }

                    for(var i = 0; i < this.post.values.length; i++){
                        labels.push('value');
                        labels.push('mean');
                        labels.push('median');
                        datas.push(this.post.values[i].value);
                        datas.push(this.statistic.mean[0]);
                        datas.push(this.statistic.median);
                    }

                    data = {
                        labels: labels,
                        datasets: [
                            {
                                label: "First dataset",
                                fillColor: "rgba(0,200,200,0.5)",
                                strokeColor: "rgba(0,200,200,0.8)",
                                highlightFill: "rgba(0,200,200,0.75)",
                                highlightStroke: "rgba(0,200,200,1)",
                                data: datas
                            }
                        ]
                    };

                    var min = Math.min.apply(null, data.datasets[0].data);
                    var max = Math.max.apply(null, data.datasets[0].data);

                    chartOpt = {
                        scaleOverride : true,
                        scaleSteps : max + 2,
                        scaleStepWidth : 1,
                        animation : false  // Edit: correction typo: from 'animated' to 'animation'
                    };

                    var myBarChart = new Chart(ctx).Bar(data, chartOpt);

                    this.$.table.innerHTML = "<table><tr><td>Variance</td><td>"+this.statistic.variance+"</td></tr><tr><td>Standard Deviation</td><td>"+this.statistic.standard_deviation+"</td></tr><tr><td>Range</td><td>"+this.statistic.range+"</td></tr></table>"
                }
                else if(this.post.type == 'TYPE_DISTRIBUTION'){

                    for(var i = 0; i < this.post.values.length; i++){
//                        labels.push(this.post.values[i].name);
                        datas.push(this.post.values[i].value);
                    }

                    data = {
                        labels: labels,
                        datasets: [
                            {
                                label: "First dataset",
                                fillColor: "rgba(0,200,200,0.5)",
                                strokeColor: "rgba(0,200,200,0.8)",
                                highlightFill: "rgba(0,200,200,0.75)",
                                highlightStroke: "rgba(0,200,200,1)",
                                data: datas
                            }
                        ]
                    }

                    var min = Math.min.apply(null, data.datasets[0].data);
                    var max = Math.max.apply(null, data.datasets[0].data);



                    chartOpt = {
                        scaleOverride : true,
                        scaleSteps : max + 2,
                        scaleStepWidth : 1,
                        animation : false  // Edit: correction typo: from 'animated' to 'animation'
                    };

                    var myBarChart = new Chart(ctx).Bar(data, chartOpt);
                }
            },
            settingsTapped: function(event, detail, sender){
                if(!this.side){
                    this.$.front.style.display = 'block';
                    this.$.back.style.display = 'none';
                    this.side = !this.side;
                }
                else{
                    this.$.front.style.display = 'none';
                    this.$.back.style.display = 'block';
                    this.side = !this.side;
                }
            },
            getGlobal: function() {
                var statistics = document.getElementById('Statistics').posts;
                console.log(statistics);
//                for(var i=0; i < statistic.length; i++){
//                    if(this.post.name == statistics[i].metric_name){
//                        this.statistic = statistics[i];
//                    }
//                    }
            },
            colChoose: function(){
//                this.$.selection.innerHTML = '<collection-drop></collection-drop>';
            }
        });
    </script>

</polymer-element>